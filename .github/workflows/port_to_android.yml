name: Fix Android Compilation Issues

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-codebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. CORREÇÃO DE RECURSOS: Cria o ícone ic_launcher.xml
      - name: Create Launcher Icon
        run: |
          mkdir -p app/src/main/res/mipmap
          cat <<EOF > app/src/main/res/mipmap/ic_launcher.xml
          <?xml version="1.0" encoding="utf-8"?>
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp"
              android:height="108dp"
              android:viewportWidth="108"
              android:viewportHeight="108">
              <path android:fillColor="#3DDC84" android:pathData="M0,0h108v108h-108z"/>
              <path android:fillColor="#FFFFFF" android:pathData="M54,54m-20,0a20,20 0 1,1 40,0a20,20 0 1,1 -40,0"/>
          </vector>
          EOF

      # 2. CORREÇÃO C++: Substitui <bits/exception.h> por <exception>
      # O header 'bits/exception.h' é interno do GCC Linux e não existe no Android NDK (Clang).
      - name: Fix DebuggableError.hpp
        run: |
          cat <<EOF > app/src/main/cpp/sources/Exceptions/DebuggableError.hpp
          #pragma once
          
          #include <exception>
          
          namespace ComSquare
          {
              class DebuggableError : public std::exception {};
          }
          EOF

      # 3. CORREÇÃO C++: Corrige Construtor de Cópia da APU
      # Muda "APU(const APU &) = default;" para "= delete;" pois a classe contém membros não copiáveis.
      - name: Fix APU.hpp Copy Constructor
        run: |
          sed -i 's/APU(const APU &) = default;/APU(const APU \&) = delete;/g' app/src/main/cpp/sources/APU/APU.hpp

      - name: Commit and Push Fixes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add app/src/main/res/mipmap/ic_launcher.xml
          git add app/src/main/cpp/sources/Exceptions/DebuggableError.hpp
          git add app/src/main/cpp/sources/APU/APU.hpp
          git commit -m "Fix: Android build errors (missing icon, invalid header, copy constructor)" || echo "No changes to commit"
          git push
